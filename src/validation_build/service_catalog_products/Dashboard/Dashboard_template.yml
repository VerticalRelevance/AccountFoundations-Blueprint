Transform: AWS::Serverless-2016-10-31

Description: >-
  CloudFormation Template to create a CloudWatch Account
Parameters: 
  Environment:
    Description: Which account is the environment being creates
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - qa
      - prod
  SourceBucketName:
      Description: 'S3 BucketName for Python functions. For example: accountsourcebucket'
      Type: String
      Default: "accountsourcebucket"
  PipelineName:
      Description: 'Name of the pipeline to monitor'
      Type: String

Mappings: 
  AccountDetails:
    #Depending on which environment is chosen, different AZ's and subnets are used to help keep the environments separate
    dev:
      AccountName: AccountFoundationsDev
    prod:
      AccountName: AccountFoundationsProd
    qa:
      AccountName: AccountFoundationsQA

Resources:
  CycleTime:
    Type: AWS::Serverless::Application
    Properties:
      # TODO: Solve this... https://github.com/aws/serverless-application-model/issues/694
      Location: "https://accountsourcebucket.s3.amazonaws.com/validation_build/service_catalog_products/Account/PipelineMetricLambda.yml"
      Parameters:
        Environment: !Ref Environment
        SourceBucketName: !Ref SourceBucketName
        PipelineName: !Ref PipelineName
        FunctionName: CycleTime
        Handler: "cycletime.handler"

  LeadTime:
    Type: AWS::Serverless::Application
    Properties:
      # TODO: Solve this... https://github.com/aws/serverless-application-model/issues/694
      Location: "https://accountsourcebucket.s3.amazonaws.com/validation_build/service_catalog_products/Account/PipelineMetricLambda.yml"
      Parameters:
        Environment: !Ref Environment
        SourceBucketName: !Ref SourceBucketName
        PipelineName: !Ref PipelineName
        FunctionName: LeadTime
        Handler: "leadtime.handler"

  MeanTimeBetweenFailure:
    Type: AWS::Serverless::Application
    Properties:
      # TODO: Solve this... https://github.com/aws/serverless-application-model/issues/694
      Location: "https://accountsourcebucket.s3.amazonaws.com/validation_build/service_catalog_products/Account/PipelineMetricLambda.yml"
      Parameters:
        Environment: !Ref Environment
        SourceBucketName: !Ref SourceBucketName
        PipelineName: !Ref PipelineName
        FunctionName: MeanTimeBetweenFailure
        Handler: "mtbf.handler"

  MeanTimeToRecovery:
    Type: AWS::Serverless::Application
    Properties:
      # TODO: Solve this... https://github.com/aws/serverless-application-model/issues/694
      Location: "https://accountsourcebucket.s3.amazonaws.com/validation_build/service_catalog_products/Account/PipelineMetricLambda.yml"
      Parameters:
        Environment: !Ref Environment
        SourceBucketName: !Ref SourceBucketName
        PipelineName: !Ref PipelineName
        FunctionName: MeanTimeToRecovery
        Handler: "mttr.handler"

  FeedbackTime:
    Type: AWS::Serverless::Application
    Properties:
      # TODO: Solve this... https://github.com/aws/serverless-application-model/issues/694
      Location: "https://accountsourcebucket.s3.amazonaws.com/validation_build/service_catalog_products/Account/PipelineMetricLambda.yml"
      Parameters:
        Environment: !Ref Environment
        SourceBucketName: !Ref SourceBucketName
        PipelineName: !Ref PipelineName
        FunctionName: FeedbackTime
        Handler: "feedbacktime.handler"
        
  Account:
      Type: "AWS::CloudWatch::Account"
      Properties:
          AccountName: !FindInMap ['AccountDetails', !Ref Environment, 'AccountName']
          AccountBody: !Sub |
              {
                "widgets":[
                    {
                      "type":"metric",
                      "x":0,
                      "y":0,
                      "width":21,
                      "height":3,
                      "properties":{
                          "view":"singleValue",
                          "metrics":[
                            [
                                "Pipeline", "SuccessCycleTime", "PipelineName", "${PipelineName}",
                                {
                                  "label":"Cycle Time",
                                  "stat":"Average",
                                  "color":"#212ebd"
                                }
                            ],
                            [
                                ".", "DeliveryLeadTime", ".", ".",
                                {
                                  "label":"Lead Time",
                                  "stat":"Average",
                                  "color":"#d6721b"
                                }
                            ],
                            [
                                ".", "GreenTime", ".", ".",
                                {
                                  "label":"MTBF",
                                  "stat":"Average",
                                  "color":"#2ca02c"
                                }
                            ],
                            [
                                ".", "RedTime", ".", ".",
                                {
                                  "label":"MTTR",
                                  "stat":"Average",
                                  "color":"#d62728"
                                }
                            ],
                            [
                                ".", "FailureLeadTime", ".", ".",
                                {
                                  "label":"Feedback Time",
                                  "stat":"Average",
                                  "color":"#a02899"
                                }
                            ]
                          ],
                          "region":"${AWS::Region}",
                          "title":"${PipelineName}",
                          "period":2592000
                      }
                    },
                    {
                      "type":"text",
                      "x":0,
                      "y":3,
                      "width":4,
                      "height":2,
                      "properties":{
                          "markdown":"### Cycle Time\nmean time between successful pipeline executions"
                      }
                    },
                    {
                      "type":"text",
                      "x":4,
                      "y":3,
                      "width":4,
                      "height":2,
                      "properties":{
                          "markdown":"### Lead Time\nmean lead time from commit to production, including rework"
                      }
                    },
                    {
                      "type":"text",
                      "x":8,
                      "y":3,
                      "width":4,
                      "height":2,
                      "properties":{
                          "markdown":"### MTBF\nmean time between pipeline failures"
                      }
                    },
                    {
                      "type":"text",
                      "x":12,
                      "y":3,
                      "width":4,
                      "height":2,
                      "properties":{
                          "markdown":"### MTTR\nmean time to pipeline recovery"
                      }
                    },
                    {
                      "type":"text",
                      "x":16,
                      "y":3,
                      "width":4,
                      "height":2,
                      "properties":{
                          "markdown":"### Feedback Time\nmean lead time for failed pipeline executions"
                      }
                    }
                ]
              }

Outputs:
    Account:
      Description: "Account created to monitor deployment"
      Value: !Sub 
        - "https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home#accounts:name=${AccountName}"
        - AccountName: !FindInMap ['AccountDetails', !Ref Environment, 'AccountName']
