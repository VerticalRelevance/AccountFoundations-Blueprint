Transform: AWS::Serverless-2016-10-31

Description: >-
  Cloud Formation Template to create a cycle time metric
Parameters: 
  Environment:
    Description: Which account is the environment being creates
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - qa
      - prod
  SourceBucketName:
    Description: 'S3 BucketName for Python functions. For example: accountsourcebucket'
    Type: String
    Default: "accountsourcebucket"
  PipelineName:
    Description: 'Name of the pipeline to monitor'
    Type: String
  FunctionName:
    Description: 'Name of the lambda function.  For example: CycleTime'
    Type: String
  Handler:
    Description: 'The function within your code that is called to begin execution. For example: cycletime.handler'
    Type: String

Mappings: 
  Details:
    #Depending on which environment is chosen, different AZ's and subnets are used to help keep the environments separate
    dev:
      CodeKey: lambda_build/pipeline-account-dev.zip
    prod:
      CodeKey: lambda_build/pipeline-account-prod.zip
    qa:
      CodeKey: lambda_build/pipeline-account-qa.zip

Resources:
    LambdaFunction:
        Type: AWS::Serverless::Function
        DependsOn: LogGroup
        Properties:
            CodeUri: 
              Bucket: !Ref SourceBucketName
              Key: !FindInMap ['Details', !Ref Environment, 'CodeKey']
            Description: "The function that perform the scheduled notification for utility"
            FunctionName: !Ref FunctionName
            Handler: !Ref Handler
            MemorySize: 512
            Runtime: "python3.8"
            Timeout: 900
            Events:
              PipelineEventRule:
                Type: CloudWatchEvent
                Properties:
                  Pattern:
                    source:
                      - "aws.codepipeline"
                    detail-type:
                      - "CodePipeline Pipeline Execution State Change"
                      - "CodePipeline Stage Execution State Change"
                      - "CodePipeline Action Execution State Change"
                    detail:
                      pipeline:
                        - !Ref PipelineName
            Policies:
              - CloudWatchPutMetricPolicy: {}
              - CodePipelineReadOnlyPolicy: 
                  PipelineName: !Ref PipelineName
    
    LogGroup:
        Type: AWS::Logs::LogGroup
        Properties:
            LogGroupName: !Join ["/", ["/aws/lambda", !Ref Environment, !Ref FunctionName]]
